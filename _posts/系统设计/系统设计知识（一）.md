---
layout:     post
title:      系统设计知识（一）
subtitle:   缓存技术
date:       2021-03-05
author:     Jingming
header-img: img/post-bg-map.jpg
catalog: true
tags:
    - 系统设计
---

参考了九章的系统设计。

### 一、系统的访问量级

了解系统的访问量级后，就可以配置相应的技术来满足要求。

关注点在于，多少用户每天进行操作，操作的种类，操作的数量，以及操作之后，系统究竟进行了哪些的耗时操作；  
另外，这些操作往往不是平摊在24小时的每一秒上，通常情况是白天比晚上忙，一天中有顶峰操作数，一般来说是平均操作  
数的三倍。

具体来说，假设日活用户是1亿(100M)，最频繁的操作种类是浏览查询，假设每天100次，那么QPS约为100k（100M * 100 / 86400）。

一般来说，Mysql/PosgreSQL技术支持1k级别，Mongodb/Cassandra支持10k级别，Redis/Memcached(内存型nosql)100k级别。

### 二、缓存技术

查询操作过程中，瓶颈往往是读写数据库的部分速度比较慢，不满意。

缓存技术就是用于解决读数据库慢的技术（不解决写技术！）。它的原理是，使用读取速度更快但量没有数据库大的存储技术，记录数据库的复制值，

这些复制值是经常被用户访问的内容，根据二八定律，这些复制值能占80%，但实际上，缓存的命中率高达95%。

这种缓存，不一定是实在的内存或者快速存储技术，它也可以是一套系统，无论使用什么存储技术（例如文件系统可以做网络的cache），只要这套缓存系统的读取速度比直接读数据库快就可以。

memcached就是一种缓存技术，mem指的是内存缓存，d代表进程，也就是说memcached是一种运行在背景下的一种缓存进程，使用机制和hash表使用差不多。

redis也是一种缓存技术，它于memcached不同之处在于支持数据持久化，也就是一种cache though技术，在外界看来，redis里面包括了cache和DB，
只要访问redis即可。

cache使用起来，就像是带时间的hashmap。并没有DB中发生的复杂的查询逻辑。

cache和db是两套系统，它们需要保持一致性：保证从两套系统中读出数据是一样的（也就是保证从cache里面读出来的和数据库是一样的、因为先读cache）。
多线程（之前的刚从缓存删除，另一个线程就把旧数据写回来）和down机情况都会带来不一致的问题。

为什么要使用 database.set(user); cache.delete(key);？

1. 多线程的情况下，不加锁的情况下，无论代码顺序是什么，一致性都有可能被打破。而缓存技术恰不能加锁，因为加锁效率太低，得不偿失。

2. 代码中，前一条语句如果失败，后面的语句是不会执行的。第一条语句如果失败，那么不会影响系统（直接返回操作失败）；
因此，要把重心放在减少第二条语句的失败上，换言之，就是把出错概率小的语句放在后面。实际上，缓存技术是出错率较小的，因为采用的是
基于明确的哈希技术。

PS. 万一缓存挂了怎么办？

答：缓存要使用一种重要的ttl技术。也就是说，数据存放到缓存后，不是永远存在的，而是存在一个有效期ttl（例如24小时）。这不仅仅是
因为缓存的容量有限。另一点就是，保证了，在缓存挂了这种极端情况下导致数据不一致的这种情况也只会存在ttl时间。ttl时间后，就可以强制去数据库取数据更新。
