

### 乐观锁

适合冲突不太频繁，而且是短时间的事务。具体例子，例如电子商务平台里面，用户下单，系统需要更新库存的准确性，对库存变量使用乐观锁。

库存信息是读多写少的，只要在写操作之间加上乐观锁，例如同时发生两个订单，两个订单都知道当前的库存变量的版本是1，假设第一个订单成功修改了库存，把版本1变成了版本2，

那么第二个订单由于版本不是1而是2，而导致更新失败，丢弃或者进行重试，重试的时候，期待的是版本2，这次会成功。

需要重试机制，因为更新操作可能会失败。多个线程抢锁的时候，如果一个线程成功，意味着其他线程都要失败，而失败是要重试的，容易混乱。


### 幂等性Idempotence

幂等性就是多次重复执行一个函数，但是结果不会破坏业务逻辑。

如何保证。例如：存数据（例如客户的订单、支付）的时候
（1） 要把数据打上唯一的ID标记

之后存的时候判断，如果存过了，那么就不存了。

（2） 使用数据库的约束机制

建立键约束，如果检测到，那么就不重复写入数据。

（3）使用状态机

对于管理的数据，只有几种状态，例如open，paid，close，failed几种状态。

（4）乐观锁

（5）设计让操作本身就幂等

例如更新操作，每次更新相同的值不会影响最终结果，
例如删除操作，保证删除不存在的资源不会出错。